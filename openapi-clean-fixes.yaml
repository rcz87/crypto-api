# ===== OPENAPI 4.0.1 COMPREHENSIVE CLEAN FIXES =====
# Production-ready patch for all identified schema issues
# Apply these changes to: public/openapi-4.0.1-gpts-compat.yaml

# ===== 1. üóëÔ∏è REMOVE DEPRECATED PROBLEM SCHEMA =====
# DELETE lines 4558-4566:
delete_lines:
  - range: 4558-4566
    content: |
      # Legacy schema for backward compatibility (deprecated)
      Problem:
        deprecated: true
        description: |
          Deprecated: Use ProblemDetails instead.
          Legacy problem details schema for backward compatibility.
        allOf:
          - $ref: '#/components/schemas/ProblemDetails'

# ===== 2. üî¢ FIX NUMERIC DATA TYPES =====

# Line 4290: currentCVD
replace_line_4290:
  from: 'currentCVD: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "892347.15" }'
  to: 'currentCVD: { type: number, example: 892347.15, description: "Current cumulative volume delta" }'

# Line 4291: previousCVD  
replace_line_4291:
  from: 'previousCVD: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "875692.80" }'
  to: 'previousCVD: { type: number, example: 875692.80, description: "Previous period CVD value" }'

# Line 4292: deltaChange
replace_line_4292:
  from: 'deltaChange: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "+16654.35" }'
  to: 'deltaChange: { type: number, example: 16654.35, description: "CVD change from previous period" }'

# Line 4398: ema20
replace_line_4398:
  from: 'ema20: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "111250.5" }'
  to: 'ema20: { type: number, example: 111250.5, description: "20-period Exponential Moving Average" }'

# Line 4399: ema50
replace_line_4399:
  from: 'ema50: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "112100.2" }'
  to: 'ema50: { type: number, example: 112100.2, description: "50-period Exponential Moving Average" }'

# Line 4411: fundingRate
replace_line_4411:
  from: 'fundingRate: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "0.0000888594997051" }'
  to: 'fundingRate: { type: number, example: 0.0000888594997051, description: "Current funding rate (8h basis)" }'

# Line 4412: nextFundingRate
replace_line_4412:
  from: 'nextFundingRate: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "0.0001234567890123" }'
  to: 'nextFundingRate: { type: number, example: 0.0001234567890123, description: "Predicted next funding rate" }'

# Line 4425: oi
replace_line_4425:
  from: 'oi: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "234567.89" }'
  to: 'oi: { type: number, example: 234567.89, description: "Open interest in base currency" }'

# Line 4426: oiUsd
replace_line_4426:
  from: 'oiUsd: { type: string, pattern: ''^-?[0-9]+(\.[0-9]+)?$'', example: "25987653210.45" }'
  to: 'oiUsd: { type: number, example: 25987653210.45, description: "Open interest USD notional value" }'

# Line 4299: buy_volume
replace_line_4299:
  from: 'buy_volume: { type: string, example: "548291.75" }'
  to: 'buy_volume: { type: number, example: 548291.75, description: "Total buy volume" }'

# Line 4300: sell_volume
replace_line_4300:
  from: 'sell_volume: { type: string, example: "344082.81" }'
  to: 'sell_volume: { type: number, example: 344082.81, description: "Total sell volume" }'

# Line 4302: aggressive_buyers
replace_line_4302:
  from: 'aggressive_buyers: { type: string, example: "312847.20" }'
  to: 'aggressive_buyers: { type: number, example: 312847.20, description: "Market buy orders volume" }'

# Line 4303: aggressive_sellers
replace_line_4303:
  from: 'aggressive_sellers: { type: string, example: "198735.45" }'
  to: 'aggressive_sellers: { type: number, example: 198735.45, description: "Market sell orders volume" }'

# Line 4304: passive_volume
replace_line_4304:
  from: 'passive_volume: { type: string, example: "380791.91" }'
  to: 'passive_volume: { type: number, example: 380791.91, description: "Limit order volume" }'

# ===== 3. üß© FIX ENUM INCONSISTENCY =====

# Line 4311: Remove "none" from divergence_strength enum
replace_line_4311:
  from: 'divergence_strength: { type: string, enum: ["weak", "moderate", "strong", "none"], example: "none" }'
  to: 'divergence_strength: { type: string, enum: ["weak", "moderate", "strong"], example: "moderate", description: "Divergence strength (only present when divergence_present=true)" }'

# Line 4360: Update example to remove "none"
replace_line_4360:
  from: 'divergence_strength: "none"'
  to: 'divergence_strength: "moderate"'

# ===== 4. ‚úÖ ADD REQUIRED FIELDS =====

# Add required fields to CVDAnalysisResponse (after line 4276)
add_after_line_4276:
  content: 'required: ["success", "data", "timestamp"]'

# Add required fields to TechnicalAnalysisResponse (after line 4382)
add_after_line_4382:
  content: 'required: ["success", "data", "timestamp"]'

# Add required fields to FundingRateResponse (after line 4404)
add_after_line_4404:
  content: 'required: ["success", "data", "timestamp"]'

# ===== 5. üîÑ UPDATE EXAMPLES TO MATCH NUMERIC TYPES =====

# Line 4345: currentCVD example
replace_line_4345:
  from: 'currentCVD: "892347.15"'
  to: 'currentCVD: 892347.15'

# Line 4346: previousCVD example
replace_line_4346:
  from: 'previousCVD: "875692.80"'
  to: 'previousCVD: 875692.80'

# Line 4347: deltaChange example
replace_line_4347:
  from: 'deltaChange: "+16654.35"'
  to: 'deltaChange: 16654.35'

# Line 4351: buy_volume example
replace_line_4351:
  from: 'buy_volume: "548291.75"'
  to: 'buy_volume: 548291.75'

# Line 4352: sell_volume example
replace_line_4352:
  from: 'sell_volume: "344082.81"'
  to: 'sell_volume: 344082.81'

# Line 4354: aggressive_buyers example
replace_line_4354:
  from: 'aggressive_buyers: "312847.20"'
  to: 'aggressive_buyers: 312847.20'

# Line 4355: aggressive_sellers example
replace_line_4355:
  from: 'aggressive_sellers: "198735.45"'
  to: 'aggressive_sellers: 198735.45'

# Line 4356: passive_volume example
replace_line_4356:
  from: 'passive_volume: "380791.91"'
  to: 'passive_volume: 380791.91'

# ===== 6. üìã VALIDATION SUMMARY =====
fixes_summary:
  total_changes: 25
  categories:
    schema_cleanup: 1     # Remove deprecated Problem schema
    data_types: 12        # Convert string patterns to numbers
    enum_fixes: 2         # Fix divergence_strength enum
    required_fields: 3    # Add missing required arrays
    example_updates: 7    # Update examples to match new types
  
  benefits:
    - "‚úÖ Eliminates deprecated schemas"
    - "üî¢ Proper numeric types (no client-side parsing needed)"
    - "üß© Consistent enum values"
    - "‚úÖ Required field validation"
    - "üìù Clear field descriptions"
    - "üéØ Production-ready schema consistency"

# ===== PATCH VALIDATION COMPLETE =====