# OpenAPI 4.0.1 Clean Patch File
# Fixes all identified schema issues for production-ready spec
# Generated: 2025-09-17

# ===== 1. REMOVE DEPRECATED PROBLEM SCHEMA =====
--- a/public/openapi-4.0.1-gpts-compat.yaml
+++ b/public/openapi-4.0.1-gpts-compat.yaml

# Remove deprecated Problem schema (lines 4558-4566)
-    # Legacy schema for backward compatibility (deprecated)
-    Problem:
-      deprecated: true
-      description: |
-        Deprecated: Use ProblemDetails instead.
-        Legacy problem details schema for backward compatibility.
-      allOf:
-        - $ref: '#/components/schemas/ProblemDetails'

# ===== 2. FIX NUMERIC DATA TYPES =====

# Fix CVD Analysis numeric fields (lines 4290-4292)
-                currentCVD: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "892347.15" }
-                previousCVD: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "875692.80" }
-                deltaChange: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "+16654.35" }
+                currentCVD: { type: number, example: 892347.15, description: "Current cumulative volume delta" }
+                previousCVD: { type: number, example: 875692.80, description: "Previous period CVD value" }
+                deltaChange: { type: number, example: 16654.35, description: "CVD change from previous period" }

# Fix Technical Analysis EMA fields (lines 4398-4399)
-                ema20: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "111250.5" }
-                ema50: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "112100.2" }
+                ema20: { type: number, example: 111250.5, description: "20-period Exponential Moving Average" }
+                ema50: { type: number, example: 112100.2, description: "50-period Exponential Moving Average" }

# Fix Funding Rate numeric fields (lines 4411-4412)
-            fundingRate: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "0.0000888594997051" }
-            nextFundingRate: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "0.0001234567890123" }
+            fundingRate: { type: number, example: 0.0000888594997051, description: "Current funding rate (8h basis)" }
+            nextFundingRate: { type: number, example: 0.0001234567890123, description: "Predicted next funding rate" }

# Fix Open Interest numeric fields (lines 4425-4426)  
-            oi: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "234567.89" }
-            oiUsd: { type: string, pattern: '^-?[0-9]+(\.[0-9]+)?$', example: "25987653210.45" }
+            oi: { type: number, example: 234567.89, description: "Open interest in base currency" }
+            oiUsd: { type: number, example: 25987653210.45, description: "Open interest USD notional value" }

# Fix volume fields in CVD analysis
-                buy_volume: { type: string, example: "548291.75" }
-                sell_volume: { type: string, example: "344082.81" }
-                aggressive_buyers: { type: string, example: "312847.20" }
-                aggressive_sellers: { type: string, example: "198735.45" }
-                passive_volume: { type: string, example: "380791.91" }
+                buy_volume: { type: number, example: 548291.75, description: "Total buy volume" }
+                sell_volume: { type: number, example: 344082.81, description: "Total sell volume" }
+                aggressive_buyers: { type: number, example: 312847.20, description: "Market buy orders" }
+                aggressive_sellers: { type: number, example: 198735.45, description: "Market sell orders" }
+                passive_volume: { type: number, example: 380791.91, description: "Limit order volume" }

# ===== 3. FIX ENUM INCONSISTENCY =====

# Fix divergence_strength enum to remove "none" value (line 4311)
-                divergence_strength: { type: string, enum: ["weak", "moderate", "strong", "none"], example: "none" }
+                divergence_strength: { type: string, enum: ["weak", "moderate", "strong"], example: "moderate", description: "Divergence strength (only present when divergence_present=true)" }

# Update example to be consistent (lines 4360-4363)
-            divergence_strength: "none"
-            price_trend: "up"
-            cvd_trend: "up"
-            correlation_score: 0.78
+            divergence_strength: "moderate"
+            price_trend: "up" 
+            cvd_trend: "up"
+            correlation_score: 0.78

# ===== 4. ADD MISSING REQUIRED FIELDS =====

# Add required fields to CVDAnalysisResponse (after line 4276)
     CVDAnalysisResponse:
       type: object
+      required: ["success", "data", "timestamp"]
       description: |

# Add required fields to TechnicalAnalysisResponse (after line 4382)
     TechnicalAnalysisResponse:
       type: object
+      required: ["success", "data", "timestamp"]
       properties:

# Add required fields to FundingRateResponse (after line 4404)
     FundingRateResponse:
       type: object
+      required: ["success", "data", "timestamp"]
       properties:

# Add required fields to OpenInterestResponse (find and add)
     OpenInterestResponse:
       type: object
+      required: ["success", "data", "timestamp"]
       properties:

# ===== 5. UPDATE EXAMPLES TO MATCH NUMERIC TYPES =====

# Update CVD analysis example (lines 4344-4347)
-            currentCVD: "892347.15"
-            previousCVD: "875692.80"
-            deltaChange: "+16654.35"
+            currentCVD: 892347.15
+            previousCVD: 875692.80
+            deltaChange: 16654.35
             percentageChange: 1.90

# Update volume profile examples (lines 4350-4356)
-            buy_volume: "548291.75"
-            sell_volume: "344082.81"
+            buy_volume: 548291.75
+            sell_volume: 344082.81
             buy_sell_ratio: 1.59
-            aggressive_buyers: "312847.20"
-            aggressive_sellers: "198735.45"
-            passive_volume: "380791.91"
+            aggressive_buyers: 312847.20
+            aggressive_sellers: 198735.45
+            passive_volume: 380791.91

# ===== 6. CLEAN SCHEMA COMPOSITION =====

# Ensure all response schemas use consistent allOf pattern where needed
# (This will be applied during implementation for complex schemas)

# ===== 7. VALIDATION IMPROVEMENTS =====

# Add format validation for important fields
# Add minimum/maximum constraints for percentage fields
# Ensure all enum values are lowercase consistent

# ===== END OF PATCH =====